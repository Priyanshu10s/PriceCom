<!-- Price History Chart Component -->
<div class="glass-panel p-6 rounded-3xl relative overflow-hidden mt-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-xl font-bold text-white">Price Volatility Index</h3>
            <p class="text-xs text-gray-500 uppercase tracking-wider">7-Day Market Trend</p>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-electricCyan animate-pulse"></span>
            <span class="text-xs text-electricCyan font-mono">LIVE DATA</span>
        </div>
    </div>

    <div class="relative h-64 w-full">
        <canvas id="priceChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById('priceChart').getContext('2d');
        const productId = "{{ item.id }}"; // Context must provide item/product

        // Gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(0, 243, 255, 0.5)'); // Electric Cyan
        gradient.addColorStop(1, 'rgba(0, 243, 255, 0)');

        // Fetch Data
        fetch(`/scraper/api/history/${productId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) return;

                const labels = data.history.map(h => h.date);
                const prices = data.history.map(h => h.price);

                // Security Check in Frontend (Optional Visual)
                const tampered = data.history.some(h => h.status === 'tampered');
                if (tampered) {
                    console.warn("Security Alert: Data integrity compromised for some points.");
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Price (INR)',
                            data: prices,
                            borderColor: '#00f3ff',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointBackgroundColor: '#000',
                            pointBorderColor: '#00f3ff',
                            pointHoverBackgroundColor: '#00f3ff',
                            pointHoverBorderColor: '#fff',
                            fill: true,
                            tension: 0.4 // Smooth curve
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#00f3ff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                displayColors: false,
                                callbacks: {
                                    label: function (context) {
                                        return '₹ ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#666', maxTicksLimit: 5 }
                            },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#666', callback: function (value) { return '₹' + value; } }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                    }
                });
            })
            .catch(err => console.error("Chart Error:", err));
    });
</script>