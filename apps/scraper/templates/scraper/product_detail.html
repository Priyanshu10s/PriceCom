{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load freshness_filters %}

{% block title %}{{ product.name }} | PriceCom Analytics{% endblock %}

{% block content %}
<div class="relative min-h-screen pt-24 px-4 sm:px-6 lg:px-8 flex flex-col items-center">
    <!-- Reusing Vanta Background -->
    <div id="vanta-detail" class="fixed inset-0 z-[-1]"></div>

    <div class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left: Product Info Card -->
        <div class="glass-panel p-8 rounded-3xl lg:col-span-1 h-fit">
            <div class="relative w-full aspect-square mb-6 rounded-2xl overflow-hidden border border-gray-700">
                {% if product.image_url %}
                <img src="{{ product.image_url }}" alt="{{ product.name }}"
                    class="object-cover w-full h-full hover:scale-110 transition-transform duration-500">
                {% else %}
                <div class="w-full h-full bg-gray-800 flex items-center justify-center text-gray-600">NO IMAGE</div>
                {% endif %}
            </div>

            <h1 class="text-2xl font-bold text-white mb-2 leading-tight">{{ product.name }}</h1>
            <p class="text-electricCyan font-mono text-sm mb-6">{{ product.brand|default:"Unknown Brand" }}</p>

            <div class="flex flex-col gap-4">
                {% for price in product.prices.all %}
                <div
                    class="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/10 relative group/price">
                    <div>
                        <span class="text-gray-300 font-bold block">{{ price.store_name }}</span>
                        <!-- Dual-Layer Time Strategy -->
                        <div class="flex items-center gap-2 mt-1">
                            <!-- Live Heartbeat Engine -->
                            <!-- Logic: <1hr: live, <24hr: warning, >24hr: danger -->
                            <div class="pulse-dot {{ product.get_freshness_status }}"
                                title="System Status: {{ product.get_freshness_status|cut:'status-'|title }}">
                            </div>

                            <!-- Primary Layer: Scannability (Relative) -->
                            <!-- Secondary Layer: Precision (Absolute via Tooltip) -->
                            <abbr class="no-underline relative cursor-help group/tooltip"
                                data-title="Last verified at {{ price.last_updated|time:'h:i:s A' }} on {{ price.last_updated|date:'D, d M Y' }}">
                                <span class="text-xs text-gray-500 hover:text-gray-300 transition-colors">
                                    {% if price.last_updated %}
                                    {{ price.last_updated|smart_freshness }}
                                    {% else %}
                                    Pending Initial Scan
                                    {% endif %}
                                </span>
                            </abbr>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-xl font-bold text-white block">₹{{ price.current_price }}</span>
                        <a href="{{ price.product_url }}" target="_blank"
                            class="text-xs bg-electricCyan text-black px-3 py-1 rounded-full font-bold hover:bg-white transition-colors inline-block mt-1">BUY</a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Stealth Tooltip & Pulse Styles -->
            <style>
                /* Premium Tooltip Logic (CSS-Only) */
                abbr[data-title]:hover::after {
                    content: attr(data-title);
                    position: absolute;
                    bottom: 100%;
                    left: 50%;
                    transform: translateX(-50%) translateY(-8px);
                    background: #1e293b;
                    /* Slate-800 */
                    color: #ffffff;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 0.75rem;
                    white-space: nowrap;
                    z-index: 1000;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    opacity: 0;
                    animation: tooltip-fade 0.2s forwards;
                    pointer-events: none;
                }

                @keyframes tooltip-fade {
                    to {
                        opacity: 1;
                        transform: translateX(-50%) translateY(-4px);
                    }
                }

                /* Pulse Animation Engine */
                .pulse-dot {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    position: relative;
                    display: inline-flex;
                }

                .status-live {
                    background-color: #22c55e;
                    box-shadow: 0 0 8px #22c55e;
                }

                .status-delayed {
                    background-color: #f59e0b;
                }

                /* Warning */
                .status-stale {
                    background-color: #ef4444;
                }

                /* Danger */

                /* GPU-Accelerated Heartbeat */
                .status-live::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    border-radius: 50%;
                    background-color: #22c55e;
                    z-index: -1;
                    animation: heartbeat 2s infinite cubic-bezier(0, 0, 0.2, 1);
                }

                @keyframes heartbeat {
                    0% {
                        transform: scale(1);
                        opacity: 0.75;
                    }

                    100% {
                        transform: scale(2.5);
                        opacity: 0;
                    }
                }
            </style>
        </div>

        <!-- Right: Analytics & Tools -->
        <div class="lg:col-span-2 flex flex-col gap-8">

            <!-- Price History Chart Module -->
            <div class="glass-panel p-6 rounded-3xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-200"><i
                            class="fas fa-chart-line text-neonPurple mr-2"></i>Price History Analysis</h3>
                    <div class="flex gap-2">
                        <span class="px-3 py-1 bg-white/5 rounded-lg text-xs text-gray-400">7 Days</span>
                        <span class="px-3 py-1 bg-white/5 rounded-lg text-xs text-gray-400">Verified Data</span>
                    </div>
                </div>

                <!-- Injecting the verified Chart.js component -->
                {% include "scraper/partials/price_chart.html" %}
            </div>

            <!-- Action Modules -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Watchlist Tool -->
                <div class="glass-panel p-6 rounded-3xl relative overflow-hidden group">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-electricCyan/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">Set Price Alert</h3>
                    <p class="text-xs text-gray-400 mb-6">Get notified when price drops below your target.</p>

                    <form method="POST" action="{% url 'scraper:add_alert' %}" class="flex gap-2">
                        {% csrf_token %}
                        <input type="hidden" name="product_url" value="{{ product.prices.first.product_url }}">
                        <input type="number" name="target_price" placeholder="Target Price (₹)"
                            class="bg-black/50 border border-gray-600 rounded-xl px-4 py-2 text-white w-full focus:border-electricCyan outline-none">
                        <button type="submit"
                            class="bg-electricCyan text-black px-4 py-2 rounded-xl font-bold hover:bg-white transition-colors"><i
                                class="fas fa-bell"></i></button>
                    </form>
                </div>

                <!-- AI Insight (Placeholder) -->
                <div class="glass-panel p-6 rounded-3xl">
                    <h3 class="text-lg font-bold text-white mb-2">AI Prediction</h3>
                    <p class="text-sm text-gray-300">Based on historical volatility, price is expected to <span
                            class="text-green-400 font-bold">DROP</span> in the next 48 hours.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof VANTA !== 'undefined') {
            VANTA.NET({
                el: "#vanta-detail",
                mouseControls: true, touchControls: true, gyroControls: false,
                minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00,
                color: 0xbc13fe, backgroundColor: 0x050505, points: 12.00, maxDistance: 22.00, spacing: 18.00, showDots: true
            });
        }
    });
</script>
{% endblock %}